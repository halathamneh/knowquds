var sipModule=window.sipModule||{};!function(t,i){function e(){}e.prototype=i.extend({},{trigger:function(t){return this.topics&&this.topics[t]&&this.topics[t].fireWith(this,Array.prototype.slice.call(arguments,1)),this},bind:function(t){return this.topics=this.topics||{},this.topics[t]=this.topics[t]||i.Callbacks(),this.topics[t].add.apply(this.topics[t],Array.prototype.slice.call(arguments,1)),this},unbind:function(t){return this.topics&&this.topics[t]&&this.topics[t].remove.apply(this.topics[t],Array.prototype.slice.call(arguments,1)),this}}),t.Event=e}(sipModule,jQuery),function(t,a){function i(t,i){var e=this;e.app=t,e.event=i,a(function(){e.init()})}i.prototype.init=function(){var i,n=this;n.$editor=a(".js-sip-editor"),n.$image=a(".js-sip-image"),n.event.bind("init",function(){n.event.trigger("updateImage",n.app.image),n.app.points.forEach(function(t){n.renderPoint(t)})}),n.event.bind("updateImage",function(t){n.$image.attr("src",t)}),n.event.bind("updateCurrentPoint",function(t){n.setCurrentPoint(t)}),n.event.bind("currentPointFromList",function(t){n.setCurrentPoint(t)}),n.$editor.on("click",function(t){if(t.preventDefault(),a(t.target).is(".js-sip-image")){var i=n.app.generatePointId(),e={id:i,popup_type:"popup",icon_text:i,left:t.offsetX/n.$image.width()*100,top:t.offsetY/n.$image.height()*100};n.event.trigger("addPoint",e),n.setCurrentPoint(e),n.event.trigger("currentPointFromPreview",e)}}),n.$editor.on("click",".js-sip-point",function(t){var i=a(t.target).closest(".js-sip-point"),e=n.app.getPointById(i.data("id"));e&&(n.setCurrentPoint(e),n.event.trigger("currentPointFromPreview",e))}),n.event.bind("removePoint",function(t){n.$editor.find('.js-sip-point[data-id="'+t.id+'"]').remove()}),a(".js-sip-preview-control").appendTo("#sip-preview .hndle span"),a(".js-sip-preview-control").on("click",function(t){t.stopPropagation()}),a("#sip-preview .js-sip-change-image").click(function(){void 0===i&&(i=wp.media.frames.file_frame=wp.media({title:sip_params.choose_image,button:{text:sip_params.choose_image},multiple:!1})).on("select",function(){var t=i.state().get("selection").first().toJSON();a.trim(t.url.length)<0||n.event.trigger("updateImage",t.url)}),i.open()})},i.prototype.setCurrentPoint=function(t){var i=this;i.$currentPoint&&i.$currentPoint.removeClass("current"),i.$currentPoint=a('.js-sip-point[data-id="'+t.id+'"]'),i.$currentPoint.length||(i.$currentPoint=i.renderPoint(t)),i.$currentPoint.addClass("current"),i.updatePoint(i.$currentPoint,t)},i.prototype.renderPoint=function(p){var s=this,t=a('<span class="sip-point js-sip-point" data-id="'+p.id+'"></span>').appendTo(s.$editor);return t.draggable({containment:"parent",drag:function(t,i){var e=s.$image.width(),n=s.$image.height(),o=a(t.target).width(),r=a(t.target).height();p.left=(i.position.left+o/2)/e*100,p.top=(i.position.top+r/2)/n*100}}),s.updatePoint(t,p),t},i.prototype.updatePoint=function(t,i){i.icon_image?t.removeClass("sip-point-icon-text"):(t.addClass("sip-point-icon-text"),void 0!==i.icon_background&&t.css({backgroundColor:i.icon_background}),void 0!==i.icon_color&&t.css({"border-color":i.icon_color})),t.html(""),t.css({left:"calc("+i.left+"% - "+t.width()/2+"px)",top:"calc("+i.top+"% - "+t.height()/2+"px)"})},t.Preview=i}(sipModule,jQuery),function(t,p){function i(t,i){var e=this;e.app=t,e.event=i,e.$currentItem=null,p(function(){e.init()})}i.prototype.init=function(){var o,r=this;r.currentPoint=null,r.$currentItem=null,r.pointRenderer=wp.template("sip-point"),r.$list=p(".js-sip-point-list"),r.event.bind("init",function(){r.app.points.forEach(function(t){r.renderPoint(t)})}),r.event.bind("submitImagePoint",function(t){p.isArray(t.points)&&t.points.forEach(function(t){var i=r.$list.find('.js-sip-point-item[data-id="'+t.id+'"] [data-prop="product"]').val();i&&(t.product=i)})}),r.event.bind("currentPointFromPreview",function(t){r.setCurrentPoint(t)}),r.event.bind("removePoint",function(t){r.$list.find('.js-sip-point-item[data-id="'+t.id+'"]').remove()}),r.$list.on("keyup change",".js-point-input",function(t){var i=p(t.target);r.currentPoint&&(r.currentPoint[i.data("prop")]=i.val(),r.event.trigger("updateCurrentPoint",r.currentPoint))}),r.$list.on("click",".js-sip-point-item .js-sip-point-item-handle",function(t){if(p(t.target).closest(".js-remove-point").length)return!0;var i=p(t.target).closest(".js-sip-point-item");if(i.hasClass("open"))return i.removeClass("open"),!0;var e=r.app.getPointById(i.data("id"));e&&(r.setCurrentPoint(e),r.event.trigger("currentPointFromList",e))}),r.$list.on("click",".js-remove-point",function(t){var i=p(t.target).closest(".js-sip-point-item");confirm(sip_params.delete_point_confirm)&&r.event.trigger("removePoint",r.app.getPointById(i.data("id")))}),r.$list.on("click",".js-sip-add-point-images",function(t){t.preventDefault();var n=p(this).siblings(".sip-point-images-container");void 0===o&&(o=wp.media.frames.file_frame=wp.media({title:sip_params.choose_image,button:{text:sip_params.choose_image},multiple:!0})).on("select",function(){var t,i=o.state().get("selection").map(function(t){return t.toJSON(),t});for(t=0;t<i.length;++t){var e=i[t].attributes.sizes.thumbnail.url;n.append('<div data-index="'+t+'" data-id="'+i[t].id+'" class="point-image-item"><a href="#" class="js-sip-point-image-remove"><i class="dashicons dashicons-trash"></i></a><img src="'+e+'" alt=""></div>'),r.currentPoint.description_images&&r.currentPoint.description_images.length?r.currentPoint.description_images.push({id:i[t].id,url:i[t].attributes.url,thumb:i[t].attributes.sizes.thumbnail.url}):r.currentPoint.description_images=[{id:i[t].id,url:i[t].attributes.url,thumb:i[t].attributes.sizes.thumbnail.url}]}r.event.trigger("updateCurrentPoint",r.currentPoint)}),o.open()}),r.$list.on("click",".js-sip-point-image-remove",function(t){t.preventDefault();var i=p(t.target).closest(".point-image-item"),e=i.data("index");r.currentPoint.description_images.splice(e,1),i.remove()})},i.prototype.setCurrentPoint=function(t){var i=this;i.currentPoint&&i.currentPoint.id;i.$currentItem&&i.$currentItem.removeClass("open"),i.currentPoint=t,i.$currentItem=p('.js-sip-point-item[data-id="'+t.id+'"]'),i.$currentItem.length||(i.$currentItem=i.renderPoint(t)),i.$currentItem.addClass("open"),p(document.body).animate({scrollTop:i.$currentItem.offset().top-32},300)},i.prototype.renderPoint=function(t){var i=p(this.pointRenderer(t));this.$list.find(".js-point-warning").addClass("hidden"),this.$list.append(i);var e,n="popupContent_"+t.id;return i.find('[data-prop="popup_content"]').attr("id",n),wp.editor.initialize(n),i.find(".js-sip-color").wpColorPicker({change:function(t,i){var e=t.target,n=i.color.toString();p(e).val(n).trigger("change")},clear:function(t){var i=jQuery(t.target).siblings(".wp-color-picker")[0];i&&p(i).val("").trigger("change")}}),p(document.body).trigger("wc-enhanced-select-init"),i.find(".js-inp-popup-type").on("change",function(t){switch(p(t.target).val()){case"popup":p(".js-popup-title, .js-popup-content, .js-popup-position",i).removeClass("hidden"),p(".js-popup-link, .js-popup-product",i).addClass("hidden");break;case"link":p(".js-popup-link, .js-popup-title, .js-popup-position",i).removeClass("hidden"),p(".js-popup-content, .js-popup-product",i).addClass("hidden");break;case"product":p(".js-popup-product, .js-popup-position",i).removeClass("hidden"),p(".js-popup-title, .js-popup-content, .js-popup-link",i).addClass("hidden")}}),i.find(".js-sip-remove-icon-image").on("click",function(t){t.preventDefault(),i.find(".js-sip-inp-icon-image").val("").trigger("change")}),i.find(".js-sip-change-icon-image").on("click",function(t){t.preventDefault(),void 0===e&&(e=wp.media.frames.file_frame=wp.media({title:sip_params.choose_image,button:{text:sip_params.choose_image},multiple:!1})).on("select",function(){var t=e.state().get("selection").first().toJSON();p.trim(t.url.length)<0||i.find(".js-sip-inp-icon-image").val(t.url).trigger("change")}),e.open()}),i},t.PointList=i}(sipModule,jQuery),function(t,e){function i(){var i=this;i.event=new t.Event,i.preview=new t.Preview(i,i.event),i.pointList=new t.PointList(i,i.event),i.image="",i.points=[],i.pointIndex=0,i.event.bind("addPoint",function(t){i.points.push(t)}),i.event.bind("removePoint",function(t){i.points.splice(i.points.indexOf(t),1)}),i.event.bind("updateImage",function(t){i.image=t}),e(function(){i.init()})}i.prototype.init=function(){var n=this,o=e("#post");o.on("submit",function(t){if(!o.find('[name="sip_image_point"]').length){n.event.trigger("submitImagePoint",{points:n.points});var i=JSON.stringify({image:n.image}),e=JSON.stringify(n.points);o.prepend('<input type="hidden" name="sip_image_point" value="'+n.escapeAttr(i)+'" />'),o.prepend('<input type="hidden" name="sip_points" value="'+n.escapeAttr(e)+'" />'),t.preventDefault(),o.trigger("submit")}}),sip_params.image_point_data.image&&(n.image=sip_params.image_point_data.image),e.isArray(sip_params.points_data)&&(n.points=sip_params.points_data,n.points.forEach(function(t){t.id=n.generatePointId()})),n.event.trigger("init")},i.prototype.generatePointId=function(){return++this.pointIndex},i.prototype.getPointById=function(i){var e=null;return this.points.forEach(function(t){t.id===i&&(e=t)}),e},i.prototype.escapeAttr=function(t,i){return i=i?"&#13;":"\n",(""+t).replace(/&/g,"&amp;").replace(/'/g,"&apos;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r\n/g,i).replace(/[\r\n]/g,i)},t.app=new i}(sipModule,jQuery);